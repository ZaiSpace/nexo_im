---
- name: Deploy nexo_im with Ansible + Supervisor
  hosts: nexo
  become: true
  tasks:
    - name: Ensure runtime directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ deploy_root }}"
        - "{{ app_root }}"
        - "{{ shared_root }}"
        - "{{ log_root }}"

    - name: Sync repository to target host
      ansible.posix.synchronize:
        src: "{{ ((playbook_dir + '/..') | realpath) + '/' }}"
        dest: "{{ app_root }}/"
        delete: true
        recursive: true
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.idea"
          - "--exclude=.vscode"
          - "--exclude=deploy/inventory/*.ini"

    - name: Verify go.mod exists on remote
      ansible.builtin.stat:
        path: "{{ app_root }}/go.mod"
      register: go_mod_stat

    - name: Fail when go.mod is missing
      ansible.builtin.fail:
        msg: "Missing {{ app_root }}/go.mod after sync. Check synchronize src path and inventory target."
      when: not go_mod_stat.stat.exists

    - name: Configure git to use SSH for GitHub on remote
      ansible.builtin.command: git config --global url.git@github.com:.insteadOf https://github.com/
      changed_when: true

    - name: Configure Go private module settings on remote
      ansible.builtin.command: go env -w {{ item }}
      environment:
        PATH: "/usr/local/go/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"
      loop:
        - "GOPRIVATE={{ go_private }}"
        - "GONOSUMDB={{ go_private }}"
        - "GONOPROXY={{ go_private }}"
      changed_when: true

    - name: Ensure bin directory exists
      ansible.builtin.file:
        path: "{{ app_root }}/bin"
        state: directory
        mode: "0755"

    - name: Download Go modules on remote host
      ansible.builtin.command: /usr/local/go/bin/go mod download
      args:
        chdir: "{{ app_root }}"
      environment:
        GOFLAGS: "-mod=mod"
        GOPRIVATE: "{{ go_private }}"
        GONOSUMDB: "{{ go_private }}"
        GONOPROXY: "{{ go_private }}"
        PATH: "/usr/local/go/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"

    - name: Build nexo_im binary on remote host
      ansible.builtin.command: /usr/local/go/bin/go build -o bin/nexo_im ./cmd/server
      args:
        chdir: "{{ app_root }}"
      environment:
        GOFLAGS: "-mod=mod"
        CGO_ENABLED: "0"
        GOPRIVATE: "{{ go_private }}"
        GONOSUMDB: "{{ go_private }}"
        GONOPROXY: "{{ go_private }}"
        PATH: "/usr/local/go/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"

    - name: Render supervisor config
      ansible.builtin.template:
        src: templates/nexo_im.supervisor.conf.j2
        dest: "{{ supervisor_conf_path }}"
        mode: "0644"

    - name: Reread supervisor configs
      ansible.builtin.command: supervisorctl reread
      changed_when: true

    - name: Update supervisor program list
      ansible.builtin.command: supervisorctl update
      changed_when: true

    - name: Restart nexo_im
      ansible.builtin.command: supervisorctl restart "{{ app_name }}"
      changed_when: true
